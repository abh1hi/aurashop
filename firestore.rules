rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && (
        (request.auth.token.keys().hasAny(['admin']) && request.auth.token.admin == true) || 
        request.auth.token.email in ['admin@aurashop.com', 'admin@example.com', 'abhinavbhatnaria51@gmail.com']
      );
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isVendor() {
      // Check if user has vendor claim or field (adjust based on actual implementation)
      // For now, we'll rely on the store ownership check which implicitly implies vendor status
      return isAuthenticated(); 
    }

    // Users Collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      
      // Subcollections
      match /cart/{itemId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      match /wishlist/{itemId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      match /tracking_sessions/{sessionId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      match /addresses/{addressId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      match /notifications/{notificationId} {
        // User can read/write their own notifications, Admin can write to anyone's
        // User can read their own. Authenticated users (e.g. Vendors) can create (send) notifications.
        allow read: if isOwner(userId);
        allow create: if isAuthenticated();
        // Allow Admin to create/update/delete notifications (e.g. for system alerts)
        allow update, delete: if isOwner(userId) || isAdmin();
      }
    }

    // Stores Collection
    match /stores/{storeId} {
      
      // Helper to check if user is a staff member (including owner)
      function isStaff() {
        return isAuthenticated() && (
          resource.data.ownerId == request.auth.uid ||
          exists(/databases/$(database)/documents/stores/$(storeId)/staff/$(request.auth.uid))
        );
      }

      // Public can read basic info, Staff/Owner can read sensitive info
      allow read: if true; 
      
      // Creation: Any auth user
      allow create: if isAuthenticated(); 
      
      // Update: Owner only for critical fields, Staff might update operational fields (future)
      // For now, restrict to Owner or Admin
      allow update: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isAdmin());
      
      // Delete: Owner only
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;

      // Staff Subcollection
      match /staff/{staffId} {
        // Read: Owner of the store OR the staff member themselves
        allow read: if isAuthenticated() && (
          get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid ||
          request.auth.uid == staffId
        );
        
        // Write: Owner OR Admin (for final approval)
        allow write: if isAuthenticated() && (
          get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid || 
          isAdmin()
        );
      }

      // Admin Override for all subcollections (Stats, etc.)
      match /{document=**} {
        allow read, write: if isAdmin();
      }
    }

    // Store Invites Collection (Root Level)
    match /store_invites/{inviteId} {
      // Public Read (Anyone with the token/ID can check if valid)
      allow read: if true; 
      
      // Create: Store Owner Only
      allow create: if isAuthenticated() && 
        get(/databases/$(database)/documents/stores/$(request.resource.data.storeId)).data.ownerId == request.auth.uid;
      
      // Update: 
      // 1. Applicant applying (status: 'active' -> 'applied')
      // 2. Store Owner approving/rejecting
      // 3. Admin finalizing approval
      allow update: if isAuthenticated() && (
        // Scenario 1: Applicant applying
        (
          resource.data.status == 'active' && 
          request.resource.data.status == 'applied' &&
          request.resource.data.applicantUid == request.auth.uid &&
          // Cannot change critical fields
          request.resource.data.storeId == resource.data.storeId &&
          request.resource.data.role == resource.data.role
        ) ||
        // Scenario 2: Owner managing
        (
          get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid
        ) ||
        // Scenario 3: Admin
        isAdmin()
      );
    }

    // Products Collection
    match /products/{productId} {
      allow read: if true; // Public products
      
      function isValidProduct() {
        let data = request.resource.data;
        
        // Basic Type Checks
        let hasBasicFields = data.name is string 
                          && data.storeId is string
                          && data.price is number
                          && data.category is string;
                          
        // Status Check
        let isValidStatus = data.status in ['active', 'draft', 'archived'];
        
        // Draft Mode: Minimal validation
        let isDraft = data.status == 'draft';
        
        // Active Mode: Strict validation
        let isActiveValid = data.status == 'active' 
                          && data.price >= 0
                          && data.stock is number && data.stock >= 0
                          && data.images is list && data.images.size() > 0
                          && data.description is string && data.description.size() > 0;

        // New Fields Validation (Optional but must be correct type if present)
        let hasValidExtras = (!('subCategory' in data) || data.subCategory is string)
                          && (!('brand' in data) || data.brand is string)
                          && (!('tags' in data) || data.tags is list)
                          && (!('costPrice' in data) || data.costPrice is number)
                          && (!('variants' in data) || data.variants is list)
                          && (!('seo' in data) || data.seo is map);

        return hasBasicFields && isValidStatus && (isDraft || isActiveValid) && hasValidExtras;
      }

      allow create: if isAuthenticated() 
                    && get(/databases/$(database)/documents/stores/$(request.resource.data.storeId)).data.ownerId == request.auth.uid
                    && isValidProduct();
                    
      allow update: if isAuthenticated() 
                    && get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid
                    && isValidProduct();
                    
      allow delete: if isAuthenticated() 
                    && get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid;
    }

    // Orders Collection
    match /orders/{orderId} {
      allow create: if isAuthenticated(); // Customers create orders
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || // Customer
        get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid || // Vendor
        isAdmin() // Admin
      );
      allow update: if isAuthenticated() && (
        // Vendor updating status
        get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Admin Notification Logs
    match /admin_notification_logs/{logId} {
      allow read, write: if isAdmin();
    }

    // Admin Notification Drafts
    match /admin_notification_drafts/{draftId} {
      allow read, write: if isAdmin();
    }
  }
}
